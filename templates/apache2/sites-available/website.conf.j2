# {{ ansible_managed }}

Define DOMAIN {{ website_domain }}
{% if website_webalias is defined %}
Define DOMAINALIAS {{ website_webalias }}
{% endif %}

<VirtualHost *:80>
    ServerName ${DOMAIN}
{% if webalias is defined %}
    ServerAlias ${DOMAINALIAS}
{% endif %}
    ServerAdmin  {{ website_serveradmin|default('webmaster@localhost') }}
{% if website_httpsonly|default(false) %}
    Redirect permanent / https://${DOMAIN}/
{% else %}
{% if website_rootredirection is defined %}
    RedirectMatch "^/$" "{{ rootredirection }}"
{% else %}
    DocumentRoot {{ website_documentroot_base|default('/var/www/html') }}/${DOMAIN}
{% endif %}{# website_rootredirection #}
    <Directorymatch "^/.*/\.git+/">
      Order deny,allow
      Deny from all
    </Directorymatch>
    <Files ~ "^\.git">
      Order allow,deny
      Deny from all
    </Files>
{% if website_scriptalias_url is defined %}
    ScriptAlias "/{{ website_scriptalias_url }}" "{{ website_documentroot_base|default('/var/www/html') }}/${DOMAIN}/{{ website_scriptalias_path|default(website_scriptalias_url) }}"
{% endif %}{# website_scriptalias_url #}
{% if proxy is defined %}
    ProxyRequests     Off
    ProxyPreserveHost On
{% if nodecode is defined %}
    AllowEncodedSlashes NoDecode
{% endif %}
    <Proxy *>
      Order deny,allow
      Allow from all
    </Proxy>
    ProxyPass /.well-known !
    ProxyPass / {{ proxy }}
{% if nodecode is defined %}
    ProxyPassReverse / {{ proxyreverse }}
{% else %}
    ProxyPassReverse / {{ proxy }}
{% endif %}{# nodecode #}
{% endif %}{# proxy defined #}
{% endif %}{# website_httpsonly #}
    CustomLog ${APACHE_LOG_DIR}/${DOMAIN}-access.log combined
    ErrorLog ${APACHE_LOG_DIR}/${DOMAIN}-error.log
{% if website_custom_fragment is defined %}
    ## Custom Fragment ##
    {{ website_custom_fragment }}
{% endif %}
</VirtualHost>

<IfModule mod_ssl.c>
    <VirtualHost *:443>
        ServerName ${DOMAIN}
        ServerAdmin  {{ website_serveradmin|default('webmaster@localhost') }}
{% if website_webalias is defined %}
        ServerAlias ${DOMAINALIAS}
{% endif %}
{% if website_rootredirection is defined %}
        RedirectMatch "^/$" "{{ rootredirection }}"
{% else %}
        DocumentRoot {{ website_documentroot_base|default('/var/www/html') }}/${DOMAIN}
{% endif %}{# website_rootredirection #}
        <Directorymatch "^/.*/\.git+/">
          Order deny,allow
          Deny from all
        </Directorymatch>
        <Files ~ "^\.git">
          Order allow,deny
          Deny from all
        </Files>
{% if website_scriptalias_url is defined %}
        ScriptAlias "/{{ website_scriptalias_url }}" "{{ website_documentroot_base|default('/var/www/html') }}/${DOMAIN}/{{ website_scriptalias_path|default(website_scriptalias_url) }}"
{% endif %}{# website_scriptalias_url #}
        SSLEngine on
{% if website_letsencrypt is defined and website_letsencrypt %}
        SSLCertificateFile    /etc/ssl/letsencrypt/certs/${DOMAIN}/fullchain.pem
        SSLCertificateKeyFile /etc/ssl/letsencrypt/certs/${DOMAIN}/privkey.pem
{% else %}
{% if cert is defined and cert %}
        SSLCertificateFile    /etc/ssl/certs/${DOMAIN}.crt
        SSLCertificateKeyFile /etc/ssl/private/{{ ansible_fqdn }}.key
{% else %}
        SSLCertificateFile    /etc/ssl/certs/ssl-cert-snakeoil.pem
        SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key
{% endif %}{# cert is defined #}
{% endif %}{# letencrypt is defined #}

{% if proxy is defined %}
        ProxyRequests     Off
        ProxyPreserveHost On
{% if nodecode is defined %}
        AllowEncodedSlashes NoDecode
{% endif %}
        <Proxy *>
          Order deny,allow
          Allow from all
        </Proxy>
        ProxyPass /.well-known !
        ProxyPass / {{ proxy }}
{% if nodecode is defined %}
        ProxyPassReverse / {{ proxyreverse }}
{% else %}
        ProxyPassReverse / {{ proxy }}
{% endif %}

        #RedirectPermanent / http://localhost:8090/
        #RewriteEngine on
        #RewriteRule ^(.*)$ http://localhost:8090$1 [P,L]
{% endif %}
        CustomLog ${APACHE_LOG_DIR}/${DOMAIN}-access-ssl.log combined
        ErrorLog ${APACHE_LOG_DIR}/${DOMAIN}-error-ssl.log
{% if website_custom_fragment is defined %}
        ## Custom Fragment ##
        {{ website_custom_fragment }}
{% endif %}
    </VirtualHost>
</IfModule>

# vim: syntax=apache ts=4 sw=4 sts=4 sr
